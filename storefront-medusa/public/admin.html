<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Portal</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --brand-500: #0c8ee9;
      --brand-600: #0070c7;
      --surface-50: #f8fafc;
      --surface-100: #f1f5f9;
      --surface-200: #e2e8f0;
      --surface-300: #cbd5e1;
      --surface-400: #94a3b8;
      --surface-500: #64748b;
      --surface-600: #475569;
      --surface-700: #334155;
      --surface-800: #1e293b;
      --surface-900: #0f172a;
    }
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--surface-50);
      color: var(--surface-900);
      min-height: 100vh;
    }
    .font-display { font-family: 'Plus Jakarta Sans', 'Inter', system-ui, sans-serif; }

    /* Header */
    .header {
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--surface-100);
      padding: 0 24px;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 50;
    }
    .header-logo {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: var(--surface-900);
    }
    .header-logo-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: var(--surface-900);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 14px;
    }
    .header-logo-text {
      font-weight: 700;
      font-size: 18px;
      letter-spacing: -0.025em;
    }
    .header-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 10px;
      border-radius: 9999px;
      background: var(--brand-500);
      color: white;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }
    .header-user {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
      color: var(--surface-600);
    }
    .btn-ghost {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--surface-600);
      background: none;
      border: none;
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
    }
    .btn-ghost:hover { background: var(--surface-100); color: var(--surface-900); }

    /* Layout */
    .container { max-width: 1024px; margin: 0 auto; padding: 0 24px; }

    /* Login */
    .login-wrap {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: calc(100vh - 64px);
      padding: 24px;
    }
    .login-card {
      width: 100%;
      max-width: 420px;
    }
    .login-icon {
      width: 56px;
      height: 56px;
      border-radius: 16px;
      background: var(--surface-900);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
    }
    .login-icon svg { width: 28px; height: 28px; color: white; }
    .login-title {
      text-align: center;
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .login-sub {
      text-align: center;
      color: var(--surface-500);
      font-size: 14px;
      margin-bottom: 32px;
    }
    .form-group { margin-bottom: 20px; }
    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--surface-700);
      margin-bottom: 6px;
    }
    .input-field {
      width: 100%;
      border-radius: 8px;
      border: 1px solid var(--surface-300);
      background: white;
      padding: 12px 16px;
      font-size: 14px;
      color: var(--surface-900);
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      font-family: inherit;
    }
    .input-field::placeholder { color: var(--surface-400); }
    .input-field:focus {
      border-color: var(--brand-500);
      box-shadow: 0 0 0 3px rgba(12, 142, 233, 0.15);
    }
    .btn-primary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      border-radius: 8px;
      background: var(--surface-900);
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 600;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      font-family: inherit;
    }
    .btn-primary:hover { background: var(--surface-800); }
    .btn-primary:active { transform: scale(0.98); }
    .btn-primary:disabled { opacity: 0.5; pointer-events: none; }
    .error-box {
      border-radius: 12px;
      background: #fef2f2;
      border: 1px solid #fecaca;
      padding: 12px 16px;
      font-size: 14px;
      color: #b91c1c;
      margin-bottom: 20px;
    }

    /* Dashboard */
    .dash-header {
      padding: 40px 0 24px;
    }
    .dash-title {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.025em;
      margin-bottom: 4px;
    }
    .dash-sub { color: var(--surface-500); font-size: 14px; }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }
    .stat-card {
      border-radius: 16px;
      border: 1px solid var(--surface-200);
      background: white;
      padding: 24px;
      transition: box-shadow 0.3s;
    }
    .stat-card:hover { box-shadow: 0 10px 25px -5px rgba(0,0,0,0.08); }
    .stat-label { font-size: 13px; color: var(--surface-500); font-weight: 500; margin-bottom: 8px; }
    .stat-value { font-size: 28px; font-weight: 700; letter-spacing: -0.025em; }
    .stat-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 12px;
    }
    .stat-icon svg { width: 20px; height: 20px; }
    .stat-icon.blue { background: #dbeafe; color: #2563eb; }
    .stat-icon.emerald { background: #d1fae5; color: #059669; }
    .stat-icon.amber { background: #fef3c7; color: #d97706; }
    .stat-icon.purple { background: #ede9fe; color: #7c3aed; }

    .section-card {
      border-radius: 16px;
      border: 1px solid var(--surface-200);
      background: white;
      margin-bottom: 24px;
      overflow: hidden;
    }
    .section-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--surface-100);
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 16px;
    }
    .section-body { padding: 24px; }
    .product-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--surface-50);
    }
    .product-row:last-child { border-bottom: none; }
    .product-title { font-size: 14px; font-weight: 500; }
    .product-price { font-size: 14px; color: var(--surface-600); }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 10px;
      border-radius: 9999px;
      font-size: 12px;
      font-weight: 500;
    }
    .badge-green { background: #d1fae5; color: #065f46; }
    .empty-state { text-align: center; padding: 40px 20px; color: var(--surface-500); font-size: 14px; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .animate-in { animation: fadeIn 0.3s ease-out; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner { animation: spin 1s linear infinite; }

    .hidden { display: none !important; }
  </style>
</head>
<body>

<!-- Header -->
<header class="header" id="header">
  <div class="header-logo">
    <div class="header-logo-icon font-display" id="logo-letter">S</div>
    <span class="header-logo-text font-display" id="header-store-name">Store</span>
    <span class="header-badge">Admin</span>
  </div>
  <div class="header-user hidden" id="header-user">
    <span id="header-email"></span>
    <button class="btn-ghost" onclick="handleLogout()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      Sign out
    </button>
  </div>
</header>

<!-- Login View -->
<div id="login-view" class="login-wrap">
  <div class="login-card animate-in">
    <div class="login-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
      </svg>
    </div>
    <h1 class="login-title font-display">Admin Portal</h1>
    <p class="login-sub">Sign in to manage your store</p>

    <div id="login-error" class="error-box hidden"></div>

    <form onsubmit="handleLogin(event)">
      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" id="login-email" class="input-field" placeholder="you@example.com" required autofocus />
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input type="password" id="login-password" class="input-field" placeholder="••••••••" required />
      </div>
      <button type="submit" class="btn-primary" id="login-btn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        Sign in
      </button>
    </form>

    <p style="margin-top:24px; text-align:center; font-size:14px; color:var(--surface-500);">
      Not an admin? <a href="/" style="font-weight:500; color:var(--surface-900); text-decoration:none;">Visit storefront</a>
    </p>
  </div>
</div>

<!-- Dashboard View -->
<div id="dashboard-view" class="hidden">
  <div class="container animate-in">
    <div class="dash-header">
      <h1 class="dash-title font-display">Dashboard</h1>
      <p class="dash-sub">Manage your store products, orders, and customers</p>
    </div>

    <!-- Stats -->
    <div class="stats-grid" id="stats-grid">
      <div class="stat-card">
        <div class="stat-icon blue">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
        </div>
        <div class="stat-label">Products</div>
        <div class="stat-value" id="stat-products">—</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon emerald">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
        </div>
        <div class="stat-label">Orders</div>
        <div class="stat-value" id="stat-orders">—</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon amber">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        </div>
        <div class="stat-label">Customers</div>
        <div class="stat-value" id="stat-customers">—</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon purple">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
        </div>
        <div class="stat-label">Revenue</div>
        <div class="stat-value" id="stat-revenue">—</div>
      </div>
    </div>

    <!-- Products list -->
    <div class="section-card">
      <div class="section-header">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
        Products
      </div>
      <div class="section-body" id="products-list">
        <div class="empty-state">Loading...</div>
      </div>
    </div>

    <!-- Recent Orders -->
    <div class="section-card" style="margin-bottom:48px;">
      <div class="section-header">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
        Recent Orders
      </div>
      <div class="section-body" id="orders-list">
        <div class="empty-state">Loading...</div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  // State
  let token = sessionStorage.getItem('admin_token') || '';
  let adminEmail = sessionStorage.getItem('admin_email') || '';

  // Resolve store name from hostname
  const storeName = location.hostname.replace('.localhost', '').replace(/^store-/, '');
  document.getElementById('logo-letter').textContent = storeName.charAt(0).toUpperCase();
  document.getElementById('header-store-name').textContent = storeName || 'Store';

  // If we have a saved token, try to resume session
  if (token) { verifyAndShowDashboard(); }

  // Login handler
  window.handleLogin = async function(e) {
    e.preventDefault();
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    const btn = document.getElementById('login-btn');
    const errBox = document.getElementById('login-error');

    btn.disabled = true;
    btn.innerHTML = '<svg class="spinner" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg> Signing in…';
    errBox.classList.add('hidden');

    try {
      const res = await fetch('/admin/auth/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password }),
      });
      if (!res.ok) {
        const body = await res.json().catch(() => ({}));
        throw new Error(body.message || 'Invalid credentials');
      }
      const data = await res.json();
      token = data.access_token;
      adminEmail = email;
      sessionStorage.setItem('admin_token', token);
      sessionStorage.setItem('admin_email', email);
      showDashboard();
    } catch (err) {
      errBox.textContent = err.message || 'Authentication failed.';
      errBox.classList.remove('hidden');
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg> Sign in';
    }
  };

  window.handleLogout = function() {
    token = '';
    adminEmail = '';
    sessionStorage.removeItem('admin_token');
    sessionStorage.removeItem('admin_email');
    document.getElementById('login-view').classList.remove('hidden');
    document.getElementById('dashboard-view').classList.add('hidden');
    document.getElementById('header-user').classList.add('hidden');
  };

  async function verifyAndShowDashboard() {
    try {
      const res = await fetch('/admin/auth', { headers: { 'Authorization': 'Bearer ' + token } });
      if (!res.ok) throw new Error('Session expired');
      showDashboard();
    } catch {
      handleLogout();
    }
  }

  async function showDashboard() {
    document.getElementById('login-view').classList.add('hidden');
    document.getElementById('dashboard-view').classList.remove('hidden');
    document.getElementById('header-user').classList.remove('hidden');
    document.getElementById('header-email').textContent = adminEmail;
    loadStats();
  }

  async function adminGet(path) {
    const res = await fetch('/admin' + path, { headers: { 'Authorization': 'Bearer ' + token } });
    if (res.status === 401) { handleLogout(); throw new Error('Session expired'); }
    return res.json();
  }

  async function loadStats() {
    try {
      const [prods, orders, customers] = await Promise.all([
        adminGet('/products?limit=1'),
        adminGet('/orders?limit=1'),
        adminGet('/customers?limit=1'),
      ]);

      document.getElementById('stat-products').textContent = prods.count ?? 0;
      document.getElementById('stat-orders').textContent = orders.count ?? 0;
      document.getElementById('stat-customers').textContent = customers.count ?? 0;

      // Calculate revenue from orders
      let revenue = 0;
      if (orders.count > 0) {
        const allOrders = await adminGet('/orders?limit=100&status=completed');
        (allOrders.orders || []).forEach(o => { revenue += (o.total || 0); });
      }
      document.getElementById('stat-revenue').textContent = '$' + (revenue / 100).toFixed(2);

      // Load products list
      const allProds = await adminGet('/products?limit=20');
      const prodsEl = document.getElementById('products-list');
      if (!allProds.products || allProds.products.length === 0) {
        prodsEl.innerHTML = '<div class="empty-state">No products yet</div>';
      } else {
        prodsEl.innerHTML = allProds.products.map(function(p) {
          const price = p.variants && p.variants[0] && p.variants[0].prices && p.variants[0].prices[0]
            ? '$' + (p.variants[0].prices[0].amount / 100).toFixed(2) : '—';
          const variants = p.variants ? p.variants.length : 0;
          return '<div class="product-row">' +
            '<div><div class="product-title">' + escHtml(p.title) + '</div>' +
            '<div style="font-size:12px;color:var(--surface-400);margin-top:2px;">' + variants + ' variant' + (variants !== 1 ? 's' : '') + '</div></div>' +
            '<div style="display:flex;align-items:center;gap:12px;">' +
            '<span class="badge badge-green">' + p.status + '</span>' +
            '<span class="product-price">' + price + '</span>' +
            '</div></div>';
        }).join('');
      }

      // Load recent orders
      const recentOrders = await adminGet('/orders?limit=10');
      const ordersEl = document.getElementById('orders-list');
      if (!recentOrders.orders || recentOrders.orders.length === 0) {
        ordersEl.innerHTML = '<div class="empty-state">No orders yet</div>';
      } else {
        ordersEl.innerHTML = recentOrders.orders.map(function(o) {
          const total = '$' + ((o.total || 0) / 100).toFixed(2);
          const date = new Date(o.created_at).toLocaleDateString();
          return '<div class="product-row">' +
            '<div><div class="product-title">#' + (o.display_id || o.id.slice(-8)) + '</div>' +
            '<div style="font-size:12px;color:var(--surface-400);margin-top:2px;">' + date + '</div></div>' +
            '<div style="display:flex;align-items:center;gap:12px;">' +
            '<span class="badge badge-green">' + (o.status || 'pending') + '</span>' +
            '<span class="product-price">' + total + '</span>' +
            '</div></div>';
        }).join('');
      }
    } catch (err) {
      console.error('Failed to load stats:', err);
    }
  }

  function escHtml(str) {
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
  }
})();
</script>

</body>
</html>
